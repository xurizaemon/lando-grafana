name: o11y
recipe: lamp
config:
  webroot: web

proxy:
  alloy:
    - alloy.o11y.lndo.site:12345
  grafana:
    - grafana.o11y.lndo.site:3000
  graphite:
    - graphite.o11y.lndo.site:80
  loki:
    - loki.o11y.lndo.site:3100
  mimir:
    - mimir.o11y.lndo.site:9009
  tempo:
    - tempo.o11y.lndo.site:80

variables:
  OTEL_EXPORTER_OTLP_ENDPOINT: http://opentelemetry-grafana:4318

services:
  appserver:
#    build_as_root:
#      - apt update
#      - apt -y --no-install-recommends install collectd libmnl0
    config:
      vhosts: config/example/apache2/default.conf
    run_as_root:
      - collectd
    overrides:
      volumes:
        - ./config/example/collectd:/etc/collectd/collectd.conf.d
        - ./config/example/apache2/status.conf:/etc/apache2/conf-enabled/status.conf

  alloy:
    type: lando
    api: 3
    services:
      image: grafana/alloy:latest
      command: /bin/alloy run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy/data --stability.level=experimental /etc/alloy
      ports:
        - '12345'
    overrides:
      environment:
        - VIRTUAL_HOST='o11y.lndo.site'
        - HTTP_EXPOSE=12345:12345,4317:4317,4318:4318,9411:9411,14268:14268
        - HTTPS_EXPOSE=12345:12345,4317:4317,4318:4318,9411:9411,14268:14268
      volumes:
        - ./config/alloy/config.alloy:/etc/alloy/config.alloy

  grafana:
    type: lando
    api: 3
    services:
      image: grafana/grafana-enterprise:latest
      command: /run.sh
      ports:
        - '3000'
    portforward: true
    # @TODO: Persist Grafana data.
    # volumes:
    #   - grafana_data:/var/lib/grafana

  graphite:
    type: lando
    api: 3
    services:
      user: root
      image: graphiteapp/graphite-statsd
      command: /entrypoint
      ports:
        - '80'
        - '2003'
    portforward: true
    # @TODO: Persist Graphite data.
    # volumes:
    #   - graphite_data:/opt/graphite/storage

  # Port 3100
  loki:
    api: 3
    type: lando
    portforward: true
    services:
      image: grafana/loki:latest
      volumes:
        - ./config/loki/loki.yaml:/etc/loki/local-config.yaml

#  # Port 9009
#  # Volume /data/blocks, /data/tsdb, /data/rules
#  mimir:
#    api: 3
#    type: lando
#    portforward: true
#    services:
#      image: grafana/mimir:latest
#      volumes:
#        - ./config/mimir/mimir.yaml:/etc/mimir.yaml
#      entrypoint:
#        - /bin/mimir
#        - config.file=/etc/mimir.yaml
#
#  # Ports 3200, 4317, 4318
#  # Volumes /data/wal, /data/blocks
#  tempo:
#    api: 3
#    type: lando
#    portforward: true
#    services:
#      image: grafana/tempo:latest
#      volumes:
#        - ./lando/config/tempo/tempo.yaml:/etc/tempo.yaml
#      command:
#        - '-config.file=/etc/tempo.yaml'

  # Ports 3200, 4317, 4318
  tempo:
    type: lando
    api: 3
    services:
      image: grafana/tempo:latest
      user: '${UID:-}:${GID:-}'
      command:
      ports:
        - '3200'  # tempo
        - '9095'  # tempo grpc
        - '4317'  # otlp grpc
        - '4318'  # otlp http
        - '9411'  # zipkin
        - '14268' # jaeger ingest
    portforward: true
    overrides:
      entrypoint: ['/tempo', '-config.file=/etc/tempo.yaml']
      volumes:
        - ./config/tempo/tempo.yaml:/etc/tempo.yaml
        - tempo_data:/data

volumes:
  grafana_data: {}
  graphite_data: {}
  tempo_data: {}